@using CinemaWorld.Models.ViewModels.MovieProjections
@using CinemaWorld.Data.Models.Enumerations
@model MovieProjectionViewModel
@{
    ViewData["Title"] = "Book Ticket";
}

<link href="~/css/book-ticket.css" rel="stylesheet" type="text/css" media="all" asp-append-version="true">

<div class="content">
    <h1>Book Movie Ticket</h1>
    <div class="main">
        <h2>Multiplex Showing Screen @Model.MovieProjection.Hall.Id</h2>
        <div class="demo">
            <div id="seat-map">
                <div class="front">SCREEN</div>
            </div>
            <div class="booking-details">
                <ul class="book-left">
                    <li>Movie</li>
                    <li>Time</li>
                    <li>Tickets</li>
                    <li>Total</li>
                    <li>Ticket Type</li>
                    <li>Seats</li>
                </ul>
                <form asp-controller="Tickets" asp-action="Book" method="post">
                    <ul class="book-right">
                        <li>@Model.MovieProjection.Movie.Name</li>
                        <li>@Model.MovieProjection.Date</li>
                        <li>
                            <span id="counter">0</span>
                            <input id="quantity" name="Quantity" type="hidden" value="" />
                        </li>
                        <li>
                            <b>
                                <i>$</i><span id="total">0</span>
                                <input id="price" name="Price" type="hidden" value="" />
                            </b>
                        </li>
                    </ul>
                    <select class="selectpicker" data-width="fit" name="TicketType"
                            asp-items="@(Html.GetEnumSelectList<TicketType>())">
                        <option selected="" disabled="">Select Ticket Type</option>
                    </select>
                    <input name="MovieProjectionTime" type="hidden" value="@Model.MovieProjection.Date" />
                    <div class="clear"></div>
                    <ul id="selected-seats" class="scrollbar scrollbar1"></ul>
                    <input id="row" name="Row" type="hidden" value="" />
                    <input id="seat" name="Seat" type="hidden" value="" />
                    <button type="submit" class="checkout-button" asp-route-movieProjectionId="@Model.MovieProjection.Id">Book Now</button>
                </form>
                <div id="legend"></div>
            </div>
            <div style="clear:both"></div>
        </div>
    </div>
</div>

@section Scripts
{
    <script type="text/javascript" src="~/js/jquery.seat-charts.js" asp-append-version="true"></script>
    <script type="text/javascript">
        var price = 10; //price

        $(document).ready(function () {
            var $cart = $('#selected-seats'), //Sitting Area
                $ticketCounter = $('#counter'), //Tickets
                $total = $('#total'); //Total money

            var sc = $('#seat-map').seatCharts({
                map: [  //Seating chart
                    'aaaaaaaaaa',
                    'aaaaaaaaaa',
                    '__________',
                    'aaaaaaaa__',
                    'aaaaaaaaaa',
                    'aaaaaaaaaa',
                    'aaaaaaaaaa',
                    'aaaaaaaaaa',
                    'aaaaaaaaaa',
                    '__aaaaaa__'
                ],
                naming: {
                    top: false,
                    getLabel: function (character, row, column) {
                        return column;
                    }
                },
                legend: { //Definition legend
                    node: $('#legend'),
                    items: [
                        ['a', 'available', 'Available'],
                        ['a', 'unavailable', 'Sold'],
                        ['a', 'selected', 'Selected']
                    ]
                },
                click: function () { //Click event
                    if (this.status() == 'available') { //optional seat
                        $('<li>Row ' + (this.settings.row + 1) + ' / Seat ' + this.settings.label + '</li>')
                            .attr('id', 'cart-item-' + this.settings.id)
                            .data('seatId', this.settings.id)
                            .appendTo($cart);

                        let quantity = sc.find('selected').length + 1;
                        let totalPrice = recalculateTotal(sc) + price;
                        let row = this.settings.row + 1;
                        let seat = this.settings.label;

                        $ticketCounter.text(quantity);
                        $total.text(totalPrice);
                        document.getElementById('quantity').value = quantity;
                        document.getElementById('price').value = totalPrice;
                        document.getElementById('row').value = row;
                        document.getElementById('seat').value = seat;

                        return 'selected';
                    } else if (this.status() == 'selected') { //Checked
                        //Update Number
                        $ticketCounter.text(sc.find('selected').length - 1);
                        //update totalnum
                        $total.text(recalculateTotal(sc) - price);

                        //Delete reservation
                        $('#cart-item-' + this.settings.id).remove();
                        //optional
                        return 'available';
                    } else if (this.status() == 'unavailable') { //sold
                        return 'unavailable';
                    } else {
                        return this.style();
                    }
                }
            });

            //sold seat
            sc.get(['1_2', '4_4', '4_5', '6_6', '6_7', '8_5', '8_6', '8_7', '8_8', '10_1', '10_2']).status('unavailable');

        });

        //sum total money
        function recalculateTotal(sc) {
            var total = 0;
            sc.find('selected').each(function () {
                total += price;
            });

            return total;
        }
    </script>
}